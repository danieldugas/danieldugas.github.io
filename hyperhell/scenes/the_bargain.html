<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Bargain</title>
<style>
body {
  margin: 0;
  padding: 20px;
  font-family: system-ui, -apple-system, sans-serif;
  background: #1a1a1a;
  color: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 20px;
}
canvas {
  border: 2px solid #444;
  background: #000;
  max-width: 100%;
}
.controls {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
  align-items: center;
}
.control-group {
  display: flex;
  flex-direction: column;
  gap: 5px;
}
label {
  font-size: 12px;
  color: #aaa;
}
input[type="range"] {
  width: 150px;
}
.info {
  font-size: 14px;
  color: #888;
  text-align: center;
}
.help {
  position: fixed;
  top: 10px;
  left: 10px;
  background: rgba(0,0,0,0.5);
  padding: 10px;
  border-radius: 5px;
  font-size: 12px;
  color: #ccc;
  max-width: 300px;
}
</style>
</head>
<body>
<canvas id="canvas" width="600" height="600"></canvas>
<div class="help">
    <div id="help-controls" style="color:rgb(156, 156, 156);">
    WASD: Move hypercamera forwards, sideways<br>
    Q/E: Move hypercamera in ana, kata directions<br>
    IJKL: Rotate hypercamera up/down, left/right<br>
    U/O: Rotate hypercamera in wx plane<br>
    Y/P: Rotate hypercamera in wy plane<br>
    Mouse drag: Rotate sensor view<br>
    Mouse wheel: Zoom<br>
    </div>
    <br>
</div>
<script type="module">

import { Transform4D, Vector4D } from '../../4d_creatures/hyperengine/transform4d.js';
import { createHypercube } from '../../4d_creatures/hyperengine/hyperobject.js';
import { TheBargainManager } from '../game_manager/the_bargain_manager.js';
import { runHyperengine } from '../../4d_creatures/hyperengine/hyperengine.js';
import { createHyperwall, createHyperwallWithCenterHole, createSphericalWallWithHole, createSphericalFloor, createSphericalBridge  } from '../models/wall.js';
import { createCorridorTube, createCorridorTubeWithHole } from '../models/corridor.js';
import { createHypersphere } from '../../4d_creatures/models/hypersphere.js';
import { createHypercrab } from '../../4d_creatures/models/hypercrab.js';
import { createBargainer } from '../models/bargainer.js';
import { createGem } from '../models/gem.js';

let objects = [];

const _H = 3; // wall z height
const _2 = 1.0 / Math.sqrt(2);
const AREA1_ZH = 20.0;

const ROOM1 = true;
const CORRIDOR1 = true;
const ROOM2 = true;
const ROOM3 = true;

// First room
//           |---| hr
//         _3__
//       /2     \4
// x <- |1   x   
//       \7     /5
//         ----6
//           | y
//           v
//
const R1HR = 5; // hexagon radius
const R1HS = R1HR / (0.5 + _2); // hexagon side
const R1HW = 10; // w thickness of the room
const r1c = new Vector4D(0, 0, AREA1_ZH, 0);
if (ROOM1) {
  const hr = R1HR; // hexagon radius
  const hs = R1HS/2.0;
  const hw = R1HW/2.0;
  // 1
  objects.push(createHyperwall(
    new Transform4D([
      [ 1,  0,  0,  0, hr],
      [ 0, hs,  0,  0,  0],
      [ 0,  0, _H,  0,  AREA1_ZH],
      [ 0,  0,  0, hw,  0],
      [ 0,  0,  0,  0,  1]
    ]),
    0xff0000
  ));
  // 2
  objects.push(createHyperwall(
    new Transform4D([
      [    _2, hs*_2,     0,     0, hr*_2],
      [   -_2, hs*_2,     0,     0,-hr*_2],
      [     0,     0,    _H,     0,     AREA1_ZH],
      [     0,     0,     0,    hw,     0],
      [     0,     0,     0,     0,     1]
    ]),
    0x777700
  ));
  // 3
  objects.push(createHyperwall(
    new Transform4D([
      [     0,    hs,     0,     0,     0],
      [    -1,     0,     0,     0,   -hr],
      [     0,     0,    _H,     0,     AREA1_ZH],
      [     0,     0,     0,    hw,     0],
      [     0,     0,     0,     0,     1]
    ]),
    0x007700
  ));
  // 4
  objects.push(createHyperwall(
    new Transform4D([
      [   -_2, hs*_2,     0,     0,-hr*_2],
      [   -_2,-hs*_2,     0,     0,-hr*_2],
      [     0,     0,    _H,     0,     AREA1_ZH],
      [     0,     0,     0,    hw,     0],
      [     0,     0,     0,     0,     1]
    ]),
    0x777700
  ));
  // missing opposite wall, on to 5
  // 5
  objects.push(createHyperwall(
    new Transform4D([
      [   -_2,-hs*_2,     0,     0,-hr*_2],
      [    _2,-hs*_2,     0,     0, hr*_2],
      [     0,     0,    _H,     0,     AREA1_ZH],
      [     0,     0,     0,    hw,     0],
      [     0,     0,     0,     0,     1]
    ]),
    0x777700
  ));
  // 6
  objects.push(createHyperwall(
    new Transform4D([
      [     0,   -hs,     0,     0,     0],
      [     1,     0,     0,     0,    hr],
      [     0,     0,    _H,     0,     AREA1_ZH],
      [     0,     0,     0,    hw,     0],
      [     0,     0,     0,     0,     1]
    ]),
    0x00ff00
  ));
  // 7
  objects.push(createHyperwall(
    new Transform4D([
      [    _2,-hs*_2,     0,     0, hr*_2],
      [    _2, hs*_2,     0,     0, hr*_2],
      [     0,     0,    _H,     0,     AREA1_ZH],
      [     0,     0,     0,    hw,     0],
      [     0,     0,     0,     0,     1]
    ]),
    0x777700
  ));
  // w+ bounding wall
  objects.push(createHyperwall(
    new Transform4D([
      [     0,    hr,     0,     0,     0],
      [     0,     0,     0,    hr,     0],
      [     0,     0,    _H,     0,     AREA1_ZH],
      [     1,     0,     0,     0,    hw],
      [     0,     0,     0,     0,     1]
    ]),
    0x0000ff
  ));
  objects.push(createHyperwall(
    new Transform4D([
      [     0,    hr,     0,     0,     0],
      [     0,     0,     0,    hr,     0],
      [     0,     0,    _H,     0,     AREA1_ZH],
      [    -1,     0,     0,     0,   -hw],
      [     0,     0,     0,     0,     1]
    ]),
    0x000077
  ));
}

// First corridor
const C1ml = 50.0;
if (CORRIDOR1) {
  const center = new Vector4D(- R1HR - C1ml / 2.0, 0, AREA1_ZH, 0);
  const main_dir = new Vector4D(1,0,0,0);
  const main_length = C1ml;
  const dir1 = new Vector4D(0,1,0,0);
  const dir2 = new Vector4D(0,0,0,1);
  const length1 = R1HS;
  const length2 = R1HW;
  createCorridorTube(objects, center, main_dir, main_length, dir1, dir2, length1, length2, _H);
}

// Second room, cubic with two exits (+x and -w)
const R2R = 10.0;
const R2X = -R1HR - C1ml - R2R; // center of room2 in x
const C2R = 5.0; // corridor 2 size (both dims)
const r2c = new Vector4D(R2X, 0, AREA1_ZH, 0); // convenience
if (ROOM2) {
  const _r = R2R;
  const h1f1 = R1HS / 2.0 / R2R;
  const h1f2 = R1HW / 2.0 / R2R;
  createHyperwallWithCenterHole(objects,
    new Transform4D([
        [1, 0, 0, 0, _r + R2X],
        [0, _r, 0, 0, 0],
        [0, 0, _H, 0, AREA1_ZH],
        [0, 0, 0, _r, 0],
        [0, 0, 0, 0, 1]
    ]),
    h1f1, h1f2,
    0xff0000
  );
  objects.push(createHyperwall(
    new Transform4D([
      [1, 0, 0, 0, -_r + R2X],
      [0, _r, 0, 0, 0],
      [0, 0, _H, 0, AREA1_ZH],
      [0, 0, 0, _r, 0],
      [0, 0, 0, 0, 1]
    ]),
    0x770000
  ));
  objects.push(createHyperwall(new Transform4D([
      [0, _r, 0, 0, R2X],
      [1, 0, 0, 0, _r],
      [0, 0, _H, 0, AREA1_ZH],
      [0, 0, 0, _r, 0],
      [0, 0, 0, 0, 1]
  ]), 0x00ff00));
  objects.push(createHyperwall(new Transform4D([
      [0, _r, 0, 0, R2X],
      [1, 0, 0, 0, -_r],
      [0, 0, _H, 0, AREA1_ZH],
      [0, 0, 0, _r, 0],
      [0, 0, 0, 0, 1]
  ]), 0x007700));
  objects.push(createHyperwall(new Transform4D([
      [0, _r, 0, 0, R2X],
      [0, 0, 0, _r, 0],
      [0, 0, _H, 0, AREA1_ZH],
      [1, 0, 0, 0, _r],
      [0, 0, 0, 0, 1]
  ]), 0x0000ff));
  const h2f = C2R / 2.0 / R2R;
  createHyperwallWithCenterHole(objects,
    new Transform4D([
      [0, _r, 0, 0, R2X],
      [0, 0, 0, _r, 0],
      [0, 0, _H, 0, AREA1_ZH],
      [1, 0, 0, 0, -_r],
      [0, 0, 0, 0, 1]
    ]),
    h2f, h2f,
    0x000077
  );

  // Bargainer
  let bargainer = createBargainer();
  bargainer.pose.matrix[0][0] = 2.0;
  bargainer.pose.matrix[1][1] = 2.0;
  bargainer.pose.matrix[2][2] = 2.0;
  bargainer.pose.matrix[3][3] = 2.0;
  bargainer.pose.rotate_self_by_delta('XY', Math.PI, true);
  bargainer.pose.translate_self_by_delta(R2X - R2R, 0, 1.0+AREA1_ZH, 0);
  objects.push(bargainer);

} // ROOM 2

// First area is elevated and so needs a floor surface
const area1xmax = R1HR;
const area1xmin = R2X - R2R;
const area1ymax = R2R;
const area1ymin = -R2R;
const area1wmax = R2R;
const area1wmin = -R2R;
const a1xl = area1xmax - area1xmin;
const a1yl = area1ymax - area1ymin;
const a1wl = area1wmax - area1wmin;
const a1c = new Vector4D(
  (area1xmax + area1xmin) / 2.0,
  (area1ymax + area1ymin) / 2.0,
  AREA1_ZH,
  (area1wmax + area1wmin) / 2.0
);
let area1Floor = createHyperwall(
    new Transform4D([
      [ 0, a1xl/2.0,  0,  0,a1c.x],
      [ 0,  0,a1yl/2.0,  0, a1c.y],
      [ 1,  0,  0,      0,  a1c.z],
      [ 0,  0,  0,a1wl/2.0, a1c.w],
      [ 0,  0,  0,  0,  1]
    ]),
    0xffffff
  );
area1Floor.collider = null; // height is handled in the player controller
objects.push(area1Floor);

// End of Area1 -------------------------------------------

// corridor 2 (falling down)
let c2l = AREA1_ZH;
let c2c = new Vector4D(R2X, 0, AREA1_ZH / 2.0 + _H, -R2R - C2R / 2.0);
createCorridorTubeWithHole(objects, c2c, new Vector4D(0,0,-1,0), c2l, new Vector4D(0,0,0,1), new Vector4D(1,0,0,0), C2R, C2R, -c2l / 2.0 + _H / 2.0, _H + 1.0, new Vector4D(0,1,0,0), C2R, true);

// Area2 ------------------------------------------------ 

// Corridor 3 (-w, gun)
const c3r = C2R;
const C3L = 30.0;
let c3c = new Vector4D(R2X, 0, 0, -R2R - C3L / 2.0);
createCorridorTubeWithHole(objects, c3c, new Vector4D(0,0,0,-1), C3L, new Vector4D(1,0,0,0), new Vector4D(0,1,0,0), c3r, c3r, 0.0, 0.0, new Vector4D(0,0,1,0), _H, false);

// Corridor 4
const c4r = c3r;
const C4L = 30.0;
let c4c = new Vector4D(R2X, 0, 0, -R2R - C3L - C4L / 2.0);
createCorridorTubeWithHole(objects, c4c, new Vector4D(0,0,0,1), C4L, new Vector4D(0,1,0,0), new Vector4D(1,0,0,0), c4r, c4r, -C4L / 2.0 + c4r, c4r, new Vector4D(0,0,1,0), _H, false);

// Corridor 5a (y+)
const c5ar1 = c4r;
const C5A_R2 = 20.0;
const C5A_L = 30.0;
let c5c = new Vector4D(R2X, C5A_L / 2.0 + c4r / 2.0, 0, -R2R - C3L - C4L + c4r);
createCorridorTube(objects, c5c, new Vector4D(0,1,0,0), C5A_L, new Vector4D(0,0,0,1), new Vector4D(1,0,0,0), c5ar1, C5A_R2, _H);

// Room 3

const r3_entrance = new Vector4D(R2X, C5A_L + C5A_R2 / 2.0, 0, -R2R - C3L - C4L + c4r);
const R3YL = 40.0;
const R3WL = 70.0;
const R3XL = C5A_R2;
const R3_ENDYL = 10.0; // wall 5 y length
const R3_OUTWL = 5.0 / _2; // out opening width in W
const R3_OUTYL = 10.0; // out corridor (w7) y side
const R3_OUTXL = R3XL;
const r3_ref = new Vector4D(R2X, C5A_L + c5ar1 / 2.0, 0, -R2R - C3L - C4L + c4r / 2.0); // ref point
//                     . r3_ref
//        \          / |
//c6_ref . \6      3/  | 1
//       7\ \__4___/   |   |
//        5|___________|   v y
//               2
//            w <-- 
const w1_c = r3_ref.add(new Vector4D(0, R3YL / 2.0, 0, 0));
const w2_c = w1_c.add(new Vector4D(0, R3YL/2.0, 0, R3WL / 2.0));
const w3_dy = R3YL - R3_ENDYL;
const w3_dw = w3_dy;
const w3_wyl = Math.sqrt(w3_dw * w3_dw + w3_dy * w3_dy);
const w3_c = r3_ref.add(new Vector4D(0, w3_dy/2.0, 0, c5ar1 + w3_dw/2.0));
const w4_wl = R3WL - c5ar1 - w3_dw - R3_OUTWL;
const w4_c = w3_c.add(new Vector4D(0, w3_dy/2.0, 0, w3_dw/2.0 + w4_wl / 2.0));
const w5_yl = R3_ENDYL;
const w5_c = w2_c.add(new Vector4D(0, -w5_yl/2.0, 0, R3WL / 2.0));
const w7_dy = R3_OUTYL;
const w7_dw = R3_OUTYL;
const w7_wyl = Math.sqrt(w7_dw * w7_dw + w7_dy * w7_dy);
const w6_dw = w7_dw + R3_OUTWL;
const w6_dy = w6_dw;
const w6_wyl = Math.sqrt(w6_dw * w6_dw + w6_dy * w6_dy);
const w6_c = w4_c.add(new Vector4D(0, -w6_dy/2.0, 0, w4_wl / 2.0 + w6_dw / 2.0));
const w7_c = w5_c.add(new Vector4D(0, -w5_yl/2.0 -w7_dy/2.0, 0, w7_dw/2.0));
const w8_c = r3_ref.add(new Vector4D(R3XL/2.0, R3YL/2.0, 0, (R3WL + w7_dw)/2.0));
const w9_c = r3_ref.add(new Vector4D(-R3XL/2.0, R3YL/2.0, 0, (R3WL + w7_dw)/2.0));
if (ROOM3) {
  // 1
  objects.push(createHyperwall(
    new Transform4D([
      [ 0,        0,  0,  R3XL/2.0, w1_c.x],
      [ 0, R3YL/2.0,  0,         0, w1_c.y],
      [ 0,        0, _H,         0, w1_c.z],
      [ 1,        0,  0,         0, w1_c.w],
      [ 0,        0,  0,         0,      1]
    ]),
    0xff0000
  ));
  // w2
  objects.push(createHyperwall(
    new Transform4D([
      [ 0,        0,  0,  R3XL/2.0, w2_c.x],
      [-1,        0,  0,         0, w2_c.y],
      [ 0,        0, _H,         0, w2_c.z],
      [ 0, R3WL/2.0,  0,         0, w2_c.w],
      [ 0,        0,  0,         0,      1]
    ]),
    0x00ff00
  ));
  // w3
  objects.push(createHyperwall(
    new Transform4D([
      [  0,             0,  0,  R3XL/2.0, w3_c.x],
      [-_2, w3_wyl/2.0*_2,  0,         0, w3_c.y],
      [  0,             0, _H,         0, w3_c.z],
      [ _2, w3_wyl/2.0*_2,  0,         0, w3_c.w],
      [  0,             0,  0,         0,      1]
    ]),
    0xffff00
  ));
  // w4
  objects.push(createHyperwall(
    new Transform4D([
      [ 0,         0,  0,  R3XL/2.0, w4_c.x],
      [-1,         0,  0,         0, w4_c.y],
      [ 0,         0, _H,         0, w4_c.z],
      [ 0, w4_wl/2.0,  0,         0, w4_c.w],
      [ 0,         0,  0,         0,      1]
    ]),
    0x00ff00
  ));
  // w5
  objects.push(createHyperwall(
    new Transform4D([
      [ 0,        0,  0,  R3XL/2.0, w5_c.x],
      [ 0, w5_yl/2.0,  0,         0, w5_c.y],
      [ 0,        0, _H,         0, w5_c.z],
      [ 1,        0,  0,         0, w5_c.w],
      [ 0,        0,  0,         0,      1]
    ]),
    0xff0000
  ));
  // w6
  objects.push(createHyperwall(
    new Transform4D([
      [  0,             0,  0,  R3XL/2.0, w6_c.x],
      [ _2, w6_wyl/2.0*_2,  0,         0, w6_c.y],
      [  0,             0, _H,         0, w6_c.z],
      [ _2,-w6_wyl/2.0*_2,  0,         0, w6_c.w],
      [  0,             0,  0,         0,      1]
    ]),
    0xffff00
  ));
  // w7
  objects.push(createHyperwall(
    new Transform4D([
      [  0,             0,  0,  R3XL/2.0, w7_c.x],
      [ _2, w7_wyl/2.0*_2,  0,         0, w7_c.y],
      [  0,             0, _H,         0, w7_c.z],
      [ _2,-w7_wyl/2.0*_2,  0,         0, w7_c.w],
      [  0,             0,  0,         0,      1]
    ]),
    0xffff00
  ));
  // w8
  objects.push(createHyperwall(
    new Transform4D([
      [ 1,        0,  0,                0, w8_c.x],
      [ 0, R3YL/2.0,  0,                0, w8_c.y],
      [ 0,        0, _H,                0, w8_c.z],
      [ 0,        0,  0, (R3WL+w7_dw)/2.0, w8_c.w],
      [ 0,        0,  0,                0,      1]
    ]),
    0x0000ff
  ));
  // w9
  objects.push(createHyperwall(
    new Transform4D([
      [ 1,        0,  0,                0, w9_c.x],
      [ 0, R3YL/2.0,  0,                0, w9_c.y],
      [ 0,        0, _H,                0, w9_c.z],
      [ 0,        0,  0, (R3WL+w7_dw)/2.0, w9_c.w],
      [ 0,        0,  0,                0,      1]
    ]),
    0x0000ff
  ));

}

// Corridor 6
// see room 3 diagram for ref point
const c6_ref = r3_ref.add(new Vector4D(0, R3YL - R3_ENDYL - R3_OUTYL, 0, R3WL + R3_OUTYL));
const c6_yd = R3_OUTWL;
const C6_XL = 60.0;
const C6_WD = c6_yd;
const c6_c = c6_ref.add(new Vector4D(0, -R3_OUTWL / 2.0, 0, C6_WD/2.0));
// x+ corridor, hole in -w dir
createCorridorTubeWithHole(objects, c6_c, new Vector4D(-1,0,0,0), C6_XL, new Vector4D(0,0,0,-1), new Vector4D(0,1,0,0), C6_WD, c6_yd, 0.0, R3_OUTXL, new Vector4D(0,0,1,0), _H, false);

// Room 4         _
//          /\       
//        4/  \3     | L
//    ____/8/\7\     _
//d |      /|.  \ |  _ c7_ref in the middle of the room
//    ___. \|   / |
//   r4ref\5\/6/  v
//        1\  /2  y
//          \/
//       x <-- 
//
//       11     12
//       --------
//       | |   | |
//    -----------
//      -| |   | |  r4_ref in W middle
//    ------------  
//       | |   | |
//       ----. ---   c7_ref in -W
//        9      10
const R4_L = 15.0;
const R4_YL = 2 * R4_L + 2 *c6_yd;
const R4_XL = 2 * R4_L + c6_yd;
const R4_WL = C6_WD * 3;
const R4_d = c6_yd / 2.0;
const R4_l = 10.0;
const R4_OUTYR = 2.0;
const C7_DY = 5.0;
const C7_DX = 5.0;
const r4_ref = c6_ref.add(new Vector4D(-C6_XL/2.0, 0, 0, C6_WD/2.0)); // in W middle
const c7_ref = r4_ref.add(new Vector4D(-R4_L, -R4_d, 0, -R4_WL/2.0)); // at -W end, but X, Y middle
const r4_entrance = r4_ref.add(new Vector4D(0, -R4_d, 0, 0)); 
if (true) {
  const w1_xl = R4_L;
  const w1_yl = R4_L;
  const w1_xyl = Math.sqrt(w1_xl * w1_xl + w1_yl * w1_yl);
  const w1_c = r4_ref.add(new Vector4D(-w1_xl/2.0, w1_yl/2.0, 0, 0));
  const w2_xl = R4_L + R4_d;
  const w2_yl = R4_L + R4_d;
  const w2_xyl = Math.sqrt(w2_xl * w2_xl + w2_yl * w2_yl);
  const w2_c = r4_ref.add(new Vector4D(-w1_xl -w2_xl/2.0, w1_yl - w2_yl/2.0, 0, 0));
  const ref2 = r4_ref.add(new Vector4D(-w1_xl -w2_xl, w1_yl - w2_yl, 0, 0)); // tip of the room
  const w3_xl = R4_L + R4_d;
  const w3_yl = R4_L + R4_d;
  const w3_xyl = Math.sqrt(w3_xl * w3_xl + w3_yl * w3_yl);
  const w3_c = ref2.add(new Vector4D(w3_xl/2.0, -w3_yl/2.0, 0, 0));
  const w4_xl = R4_L;
  const w4_yl = R4_L;
  const w4_xyl = Math.sqrt(w4_xl * w4_xl + w4_yl * w4_yl);
  const w4_c = ref2.add(new Vector4D(w3_xl + w4_xl/2.0, -w3_yl + w4_yl/2.0, 0, 0));
  const ref3 = c7_ref.add(new Vector4D(R4_l, 0, 0, R4_WL/2.0)); // left tip of inner room
  const w5_xl = R4_l;
  const w5_yl = R4_l;
  const w5_xyl = Math.sqrt(w5_xl * w5_xl + w5_yl * w5_yl);
  const w5_c = ref3.add(new Vector4D(-w5_xl/2.0, w5_yl/2.0, 0, 0));
  const w6_xl = R4_l - R4_OUTYR;
  const w6_yl = R4_l - R4_OUTYR;
  const w6_xyl = Math.sqrt(w6_xl * w6_xl + w6_yl * w6_yl);
  const w6_c = ref3.add(new Vector4D(-w5_xl -w6_xl/2.0, w5_yl - w6_yl/2.0, 0, 0));
  const w8_xl = R4_l;
  const w8_yl = R4_l;
  const w8_xyl = Math.sqrt(w8_xl * w8_xl + w8_yl * w8_yl);
  const w8_c = ref3.add(new Vector4D(-w8_xl/2.0, -w8_yl/2.0, 0, 0));
  const w7_xl = R4_l - R4_OUTYR;
  const w7_yl = R4_l - R4_OUTYR;
  const w7_xyl = Math.sqrt(w7_xl * w7_xl + w7_yl * w7_yl);
  const w7_c = ref3.add(new Vector4D(-w8_xl -w7_xl/2.0, -w8_yl + w7_yl/2.0, 0, 0));
  // W- wall with hole
  const w9_xl = 2 * R4_L;
  const w9_yl = R4_YL;
  const w9_c = c7_ref;
  // W- wall on the side
  const w10_xl = R4_d;
  const w10_yl = R4_YL;
  const w10_c = c7_ref.add(new Vector4D(-R4_L -R4_d / 2.0, 0, 0, 0));
  // W+ wall in the middle
  const w11_xl = 2 * R4_L;
  const w11_yl = R4_YL;
  const w11_c = c7_ref.add(new Vector4D(0, 0, 0, R4_WL));
  // W+ wall on the side
  const w12_xl = R4_d;
  const w12_yl = R4_YL;
  const w12_c = c7_ref.add(new Vector4D(-R4_L -R4_d / 2.0, 0, 0, R4_WL));
  // Temporarily add a square between wall
  const wt1_xl = 20.0;
  const wt1_yl = 20.0;
  const wt1_c = c7_ref.add(new Vector4D(0, 0, 0, R4_WL/3.0));
  const wt2_xl = 20.0;
  const wt2_yl = 20.0;
  const wt2_c = c7_ref.add(new Vector4D(0, 0, 0, 2 * R4_WL/3.0));


  // w1: bottom-left diagonal
  objects.push(createHyperwall(
    new Transform4D([
      [-_2, w1_xyl/2.0*_2,  0,        0, w1_c.x],
      [-_2,-w1_xyl/2.0*_2,  0,        0, w1_c.y],
      [  0,             0, _H,        0, w1_c.z],
      [  0,             0,  0, R4_WL/2, w1_c.w],
      [  0,             0,  0,        0,      1]
    ]),
    0xff0000
  ));
  // w2: bottom-right diagonal
  objects.push(createHyperwall(
    new Transform4D([
      [-_2,-w2_xyl/2.0*_2,  0,        0, w2_c.x],
      [ _2,-w2_xyl/2.0*_2,  0,        0, w2_c.y],
      [  0,             0, _H,        0, w2_c.z],
      [  0,             0,  0, R4_WL/2, w2_c.w],
      [  0,             0,  0,        0,      1]
    ]),
    0xff7700
  ));
  // w3: top-right diagonal
  objects.push(createHyperwall(
    new Transform4D([
      [ _2,-w3_xyl/2.0*_2,  0,        0, w3_c.x],
      [ _2, w3_xyl/2.0*_2,  0,        0, w3_c.y],
      [  0,             0, _H,        0, w3_c.z],
      [  0,             0,  0, R4_WL/2, w3_c.w],
      [  0,             0,  0,        0,      1]
    ]),
    0xffff00
  ));
  // w4: top-left diagonal
  objects.push(createHyperwall(
    new Transform4D([
      [ _2, w4_xyl/2.0*_2,  0,        0, w4_c.x],
      [-_2, w4_xyl/2.0*_2,  0,        0, w4_c.y],
      [  0,             0, _H,        0, w4_c.z],
      [  0,             0,  0, R4_WL/2, w4_c.w],
      [  0,             0,  0,        0,      1]
    ]),
    0x00ff00
  ));
  // w5: inner bottom-left diagonal
  objects.push(createHyperwall(
    new Transform4D([
      [ _2,-w5_xyl/2.0*_2,  0,        0, w5_c.x],
      [ _2, w5_xyl/2.0*_2,  0,        0, w5_c.y],
      [  0,             0, _H,        0, w5_c.z],
      [  0,             0,  0, R4_WL/2, w5_c.w],
      [  0,             0,  0,        0,      1]
    ]),
    0x00ffff
  ));
  // w6: inner bottom-right diagonal
  objects.push(createHyperwall(
    new Transform4D([
      [ _2, w6_xyl/2.0*_2,  0,        0, w6_c.x],
      [-_2, w6_xyl/2.0*_2,  0,        0, w6_c.y],
      [  0,             0, _H,        0, w6_c.z],
      [  0,             0,  0, R4_WL/2, w6_c.w],
      [  0,             0,  0,        0,      1]
    ]),
    0x0077ff
  ));
  // w7: inner top-right diagonal
  objects.push(createHyperwall(
    new Transform4D([
      [ _2, w7_xyl/2.0*_2,  0,        0, w7_c.x],
      [ _2,-w7_xyl/2.0*_2,  0,        0, w7_c.y],
      [  0,             0, _H,        0, w7_c.z],
      [  0,             0,  0, R4_WL/2, w7_c.w],
      [  0,             0,  0,        0,      1]
    ]),
    0x77ff00
  ));
  // w8: inner top-left diagonal
  objects.push(createHyperwall(
    new Transform4D([
      [ _2,-w8_xyl/2.0*_2,  0,        0, w8_c.x],
      [-_2,-w8_xyl/2.0*_2,  0,        0, w8_c.y],
      [  0,             0, _H,        0, w8_c.z],
      [  0,             0,  0, R4_WL/2, w8_c.w],
      [  0,             0,  0,        0,      1]
    ]),
    0x7700ff
  ));
  // w9: W- wall with hole (center)
  const h1f1 = C7_DX / w9_xl;
  const h1f2 = C7_DY / w9_yl;
  createHyperwallWithCenterHole(
    objects,
    new Transform4D([
      [  0, w9_xl/2.0,  0,        0, w9_c.x],
      [  0,        0,  0, w9_yl/2, w9_c.y],
      [  0,        0, _H,        0, w9_c.z],
      [ -1,        0,  0,        0, w9_c.w],
      [  0,        0,  0,        0,      1]
    ]),
    h1f1, h1f2,
    0x0000ff
  );
  // w10: W- wall on the side
  objects.push(createHyperwall(
    new Transform4D([
      [  0, w10_xl/2.0,  0,         0, w10_c.x],
      [  0,         0,  0, w10_yl/2, w10_c.y],
      [  0,         0, _H,         0, w10_c.z],
      [ -1,         0,  0,         0, w10_c.w],
      [  0,         0,  0,         0,       1]
    ]),
    0x000077
  ));
  // w11: W+ wall in the middle
  objects.push(createHyperwall(
    new Transform4D([
      [  0, w11_xl/2.0,  0,         0, w11_c.x],
      [  0,         0,  0, w11_yl/2, w11_c.y],
      [  0,         0, _H,         0, w11_c.z],
      [  1,         0,  0,         0, w11_c.w],
      [  0,         0,  0,         0,       1]
    ]),
    0x0000ff
  ));
  // w12: W+ wall on the side
  objects.push(createHyperwall(
    new Transform4D([
      [  0, w12_xl/2.0,  0,         0, w12_c.x],
      [  0,         0,  0, w12_yl/2, w12_c.y],
      [  0,         0, _H,         0, w12_c.z],
      [  1,         0,  0,         0, w12_c.w],
      [  0,         0,  0,         0,       1]
    ]),
    0x000077
  ));
  // temporary floors
  objects.push(createHyperwall(
    new Transform4D([
      [  0, wt1_xl/2.0,  0,         0, wt1_c.x],
      [  0,         0,  0, wt1_yl/2, wt1_c.y],
      [  0,         0, _H,         0, wt1_c.z],
      [  1,         0,  0,         0, wt1_c.w],
      [  0,         0,  0,         0,       1]
    ]),
    0x0000ff
  ));
  objects.push(createHyperwall(
    new Transform4D([
      [  0, wt2_xl/2.0,  0,         0, wt2_c.x],
      [  0,         0,  0, wt2_yl/2, wt2_c.y],
      [  0,         0, _H,         0, wt2_c.z],
      [  1,         0,  0,         0, wt2_c.w],
      [  0,         0,  0,         0,       1]
    ]),
    0x0000ff
  ));
}

// Corridor 7, -W direction
const C7_LW = 10.0;
const c7_c = c7_ref.add(new Vector4D(0, 0, 0, -C7_LW/2.0));
createCorridorTube(objects, c7_c, new Vector4D(0,0,0,-1), C7_LW, new Vector4D(1,0,0,0), new Vector4D(0,1,0,0), C7_DX, C7_DY, _H);

// Room 5
//   ___
//   |  xxxx
// --   xxxx
// --             | y
//   |__xxxx      v
//  w <--

const R5_WL = 60.0;
const R5_DX = 20.0;
const R5_DY = 20.0;
const R5_BX = 5.0;
const R5_BY = 5.0;
const R5_BZ = 0.5;
const R5_BoffsetX = 1.0;
const R5_BoffsetY = 2.0;
const R5_LAVA_WL = 30.0;
const C8_LW = 10.0;
const C8_DX = 10.0;
const C8_DY = 10.0;
const r5_shore_wl = (R5_WL - R5_LAVA_WL) / 2.0;
const r5_entrance = c7_c.add(new Vector4D(0, 0, 0, -C7_LW/2.0));
const r5_c = r5_entrance.add(new Vector4D(0, 0, 0, -R5_WL/2.0));
const r5_firstshore_c = r5_entrance.add(new Vector4D(0, 0, 0, -r5_shore_wl/2.0));
const r5_secondshore_c = r5_c.add(new Vector4D(0, 0, 0, -R5_LAVA_WL/2.0 -r5_shore_wl/2.0));
const r5_bc = r5_c.add(new Vector4D(R5_BoffsetX, R5_BoffsetY, 0, 0, -R5_BZ/2.0));
const r5_exit = r5_c.add(new Vector4D(0, 0, 0, -R5_WL/2.0));
if (true) {
  const h1f1 = C7_DX / R5_DX;
  const h1f2 = C7_DY / R5_DY;
  createHyperwallWithCenterHole(objects,
      new Transform4D([
          [0, R5_DX/2.0,  0,       0, r5_entrance.x],
          [0,         0,  0, R5_DY/2, r5_entrance.y],
          [0,         0, _H,       0, r5_entrance.z],
          [1,         0,  0,       0, r5_entrance.w],
          [0,         0,  0,       0, 1]
      ]),
      h1f1, h1f2,
      0xff0000
  );
  createCorridorTube(objects, r5_firstshore_c, new Vector4D(0,0,0,-1), r5_shore_wl, new Vector4D(1,0,0,0), new Vector4D(0,1,0,0), R5_DX, R5_DY, _H);
  // Lava surface
  objects.push(createHyperwall(
    new Transform4D([
      [ 0, R5_DX/2.0*3,         0,              0,  r5_c.x],
      [ 0,         0,   R5_DY/2*100,              0,  r5_c.y],
      [ 1,         0,         0,              0,  r5_c.z+0.1],
      [ 0,         0,         0, R5_LAVA_WL/2.0,  r5_c.w],
      [ 0,         0,         0,              0,  1]
    ]),
    0xff7700
  ));
  objects[objects.length-1].collider = null;
  createCorridorTube(objects, r5_secondshore_c, new Vector4D(0,0,0,-1), r5_shore_wl, new Vector4D(1,0,0,0), new Vector4D(0,1,0,0), R5_DX, R5_DY, _H);
  // Bridge
  objects.push(createHypercube(
    new Transform4D([
      [ R5_BX/2.0,         0,         0,              0,  r5_bc.x],
      [         0, R5_BY/2.0,         0,              0,  r5_bc.y],
      [         0,         0, R5_BZ/2.0,              0,  r5_bc.z],
      [         0,         0,         0, R5_LAVA_WL/2.0,  r5_bc.w],
      [         0,         0,         0,              0,  1]
    ]),
    0x222222
  ));
  objects[objects.length-1].simulate_physics = false; // static object
  // End wall
  createHyperwallWithCenterHole(objects,
      new Transform4D([
          [0, R5_DX/2.0,  0,       0, r5_exit.x],
          [0,         0,  0, R5_DY/2, r5_exit.y],
          [0,         0, _H,       0, r5_exit.z],
          [1,         0,  0,       0, r5_exit.w],
          [0,         0,  0,       0, 1]
      ]),
      C8_DX / R5_DX,
      C8_DY / R5_DY,
      0xff0000
  );
}

// Corridor 8
const c8_c = r5_exit.add(new Vector4D(0, 0, 0, -C8_LW/2.0));
createCorridorTube(objects, c8_c, new Vector4D(0,0,0,-1), C8_LW, new Vector4D(1,0,0,0), new Vector4D(0,1,0,0), C8_DX, C8_DY, _H);

// Room 6
const R6_R = 60.0;
const R6_LavaR = 50.0;
const R6_CutW = 2.0;
const R6_BridgeShellR = 30.0;
const R6_BridgeShellHZ = 0.3;
const R6_PedestalR = 7.0;
const R6_PedestalHZ = 1.0;
const r6_entrance = r5_exit.add(new Vector4D(0, 0, 0, -C8_LW));
const r6_c = r6_entrance.add(new Vector4D(0, 0, 0, -R6_R + R6_CutW));
if (true) {
  // Entrance wall
  const innerR = R6_R * 0.4;
  const h1f1 = C8_DX / innerR / 2.0;
  const h1f2 = C8_DY / innerR / 2.0;
  createHyperwallWithCenterHole(objects,
      new Transform4D([
          [0,  innerR,  0,       0, r6_entrance.x],
          [0,         0,  0,  innerR, r6_entrance.y],
          [0,         0, _H,       0, r6_entrance.z],
          [1,         0,  0,       0, r6_entrance.w],
          [0,         0,  0,       0, 1]
      ]),
      h1f1, h1f2,
      0xff0000
  );
  // outer wall
  objects.push(createSphericalWallWithHole(new Transform4D([
        [         0,         0,         0,           R6_R,  r6_c.x],
        [         0,      R6_R,         0,              0,  r6_c.y],
        [         0,         0,        _H,              0,  r6_c.z],
        [      R6_R,         0,         0,              0,  r6_c.w],
        [         0,         0,         0,              0,  1]
    ]), 
    R6_CutW / R6_R,
    0x00ffff
  ));
  // lava
  objects.push(createSphericalFloor(new Transform4D([
        [         0,         0,         0,       R6_LavaR,  r6_c.x],
        [         0,  R6_LavaR,         0,              0,  r6_c.y],
        [         0,         0,        _H,              0,  r6_c.z+0.1],
        [  R6_LavaR,         0,         0,              0,  r6_c.w], // We give this the same rotation as the outer wall to match the discontinuities
        [         0,         0,         0,              0,  1]
    ]),
    0xff7700
  ));
  // Bridge
  objects.push(createSphericalBridge(new Transform4D([
        [         0,         0,         0,       R6_BridgeShellR,  r6_c.x],
        [         0,  R6_BridgeShellR,         0,              0,  r6_c.y],
        [         0,         0, R6_BridgeShellHZ,              0,         r6_c.z],
        [  R6_BridgeShellR,         0,         0,              0,  r6_c.w], // We give this the same rotation as the outer wall to match the discontinuities
        [         0,         0,         0,              0,  1]
    ]),
    0.9, 1.1,
    0x222222
  ));
  // Pedestal
  objects.push(createSphericalBridge(new Transform4D([
        [         0,         0,         0,       R6_PedestalR,  r6_c.x],
        [         0,  R6_PedestalR,         0,              0,  r6_c.y],
        [         0,         0, R6_PedestalHZ,              0,         r6_c.z],
        [  R6_PedestalR,         0,         0,              0,  r6_c.w], // We give this the same rotation as the outer wall to match the discontinuities
        [         0,         0,         0,              0,  1]
    ]),
    0.2, 1.0,
    0x222222
  ));
  // End gem - created by the game manager
}


function the_bargain_floor_heightmap(x, y, w) {
  if (x >= area1xmin && x <= area1xmax && y >= area1ymin && y <= area1ymax && w >= area1wmin && w <= area1wmax) {
    return AREA1_ZH;
  }
  return 0.0;
}

// PoIs
let poIs = {
  roomCenters: [
    {name: "Room 1", pos: r1c},
    {name: "Room 2", pos: r2c},
    {name: "Corridor 3", pos: c3c},
    {name: "Room 3", pos: r3_entrance},
    {name: "Corridor 6", pos: c6_c},
    {name: "Room 4", pos: r4_entrance},
    {name: "Corridor 7", pos: c7_c},
    {name: "Room 5", pos: r5_entrance},
    {name: "Room 6", pos: r6_entrance},
  ],
  shadeSpawns: [
    c4c,
  ],
  crawlerSpawns: [
    {
      pos: w5_c.add(new Vector4D(0, 0, _H, 0)),
      volumeMin: new Vector4D(w5_c.x - R3XL / 2.0, w5_c.y - w5_yl / 2.0 + 1, _H, w5_c.w),
      volumeMax: new Vector4D(w5_c.x + R3XL / 2.0, w5_c.y + w5_yl / 2.0 - 1, _H, w5_c.w),
    },
  ],
  room6Center: r6_c,
};

// Check WebGPU support
if (!navigator.gpu) {
  document.body.innerHTML = '<div style="color: red; padding: 20px;">WebGPU is not supported in your browser.</div>';
  throw new Error('WebGPU not supported');
}

const main_canvas = document.getElementById('canvas');
let custom_scene = {
    visibleHyperobjects: objects,
    mainCanvas: main_canvas,
    floor_heightmap: the_bargain_floor_heightmap
};

// GameManager
// Player controls, NPCs, Monsters, etc
let gameManager = new TheBargainManager(custom_scene, poIs);
custom_scene.gameManager = gameManager;

runHyperengine(custom_scene).catch(err => {
  console.error(err);
  document.body.innerHTML += '<div style="color: red; padding: 20px;">Error: ' + err.message + '</div>';
});
</script>
</body>
</html>